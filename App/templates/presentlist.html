<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/styles.css">
    <title>CS3103 Term Project Dashboard</title>
</head>

<body class="container-fluid">
    <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-menu">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">CS3103 Dashboard</a>
        </div>
        <div class="collapse navbar-collapse" id="navbar-menu">
        <ul class="nav navbar-nav">
            <li><a href="/dashboard">Home</a></li>
            <li class="active"><a href="profile"><span class="glyphicon glyphicon-user"></span> {{ username }}'s Present Lists</a></li>
            <li><a href="/settings">Settings</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
            <li style="margin-right: 15px;"><button type="submit" id="logout-btn" class="btn btn-danger navbar-btn">Logout</button></li>
        </ul>
        </div>
    </div>
    </nav>
    
    <div class="container">
        <h1 class="text-center">Manage Your Present Lists</h1>

        <hr>
    
        <button id="showCreateForm" class="btn mb-3">Create New List</button>
    
        <div id="createPresentListContainer" class="mb-3" style="display: none;">
            <h3>Create New Present List</h3>
            <form id="createPresentListForm">
            <label for="createListName" class="form-label">Present List Name:</label>
            <input type="text" id="createListName" class="form-control" name="createListName" required>
    
            <label for="createOccasion" class="form-label">Occasion:</label>
            <input type="text" id="createOccasion" class="form-control" name="createOccasion" required>
    
            <button type="submit" class="btn btn-primary">Create Present List</button>
            <button type="button" id="cancelCreateForm" class="btn btn-secondary">Cancel</button>
            </form>
            <p id="createListResponse"></p>
        </div>
    
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                <th>Name</th>
                <th>Occasion</th>
                <th>Date Created</th>
                <th>Actions</th>
                <th>Actions</th>
                <th>Actions</th>
                <th>Actions</th>
                </tr>
            </thead>
            <tbody id="presents-table">
                <!-- Presents will be inserted here dynamically -->
            </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const createFormContainer = document.getElementById("createPresentListContainer");
            const showCreateButton = document.getElementById("showCreateForm");
            const cancelCreateButton = document.getElementById("cancelCreateForm");
            const createForm = document.getElementById("createPresentListForm");
            const responseMessage = document.getElementById("createListResponse");

            function refreshPresents() {
                fetch('/user/update', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const userId = data.data.userID;

                        return fetch(`/user/${userId}/presentlist`, {
                            method: "GET",
                            headers: { "Content-Type": "application/json" },
                            credentials: "include"
                        });
                    } else {
                        throw new Error("Failed to fetch user data");
                    }
                })
                .then(response => response.json())
                .then(data => {
                    let tableBody = document.getElementById("presents-table");
                    tableBody.innerHTML = "";

                    if (!data.present_lists || data.present_lists.length === 0) {
                        tableBody.innerHTML = "<tr><td colspan='4'>No presents found</td></tr>";
                        return;
                    }

                    data.present_lists.forEach(present => {
                        let row = `<tr>
                            <td>${present.name}</td>
                            <td>${present.occasion}</td>
                            <td>${present.dateCreated}</td>
                            <td> <button onclick="viewList(${present.presentListID})">View List</button> </td>
                            <td> <button onclick="updateList(${present.presentListID})">Change Details</button> </td>
                            <td> <button onclick="addToList(${present.presentListID})">Add Present</button> </td>
                            <td> <button class="btn btn-danger" onclick="deleteList(${present.presentListID})">Delete</button> </td>
                        </tr>`;

                        tableBody.innerHTML += row;
                    });
                })
                .catch(error => console.error("Error:", error));
            }

            // Call the function when the page loads
            refreshPresents();

            // Show form when "Create New List" is clicked
            showCreateButton.addEventListener("click", function () {
                createFormContainer.style.display = "block";
                showCreateButton.style.display = "none";
            });

            // Hide form when "Cancel" is clicked
            cancelCreateButton.addEventListener("click", function () {
                createFormContainer.style.display = "none";
                showCreateButton.style.display = "block";
                responseMessage.textContent = "";
            });

            // Handle form submission
            createForm.addEventListener("submit", function (event) {
                event.preventDefault();

                const listName = document.getElementById('createListName').value;
                const occasion = document.getElementById('createOccasion').value;

                const createData = {
                    name: listName,
                    occasion: occasion
                };

                fetch('/presentlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(createData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        responseMessage.textContent = "Present List Created Successfully!";
                        responseMessage.style.color = "green";
                        createForm.reset();

                        setTimeout(() => {
                            createFormContainer.style.display = "none";
                            showCreateButton.style.display = "block";
                            refreshPresents(); // Refresh the list
                        }, 1500);
                    } else {
                        responseMessage.textContent = "Error: " + data.message;
                        responseMessage.style.color = "red";
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    responseMessage.textContent = "An error occurred. Please try again.";
                    responseMessage.style.color = "red";
                });
            });

            // Expose refreshPresents function globally so other functions can use it
            window.refreshPresents = refreshPresents;
        });


        function deleteList(listId) {
            if (!confirm(`Are you sure you want to delete present list ID ${listId}?`)) return;
            
            fetch(`/presentlist/${listId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    alert(`Present list with ID ${listId} deleted successfully.`);
                    refreshPresents(); // Refresh after deletion
                })
                .catch(error => {
                    alert('Error deleting present list: ' + error.message);
                });
        }


        document.getElementById('updatePresentListContentsForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const listId = document.getElementById('updateListId').value;
            const addPresentName = document.getElementById('addPresentName').value;
            const deletePresentName = document.getElementById('deletePresentName').value;

            const updateData = {};
            if (addPresentName) updateData.addPresent = addPresentName;
            if (deletePresentName) updateData.deletePresent = deletePresentName;

            fetch(`/presentlist/${listId}/contents`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('updateContentsResponse').innerText = 'Present list contents updated successfully.';
            })
            .catch(error => {
                document.getElementById('updateContentsResponse').innerText = 'Error updating present list contents';
                alert('Error updating present list contents: ' + error.message);
            });
        });

        document.getElementById('updatePresentListInfoForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const listId = document.getElementById('updatePresentListId').value;
            const newListName = document.getElementById('updatePresentListName').value;
            const newOccasion = document.getElementById('updateOccasion').value;

            const updateData = {};
            if (newListName) updateData.name = newListName;
            if (newOccasion) updateData.occasion = newOccasion;

            fetch(`/presentlist/${listId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('updateInfoResponse').innerText = 'Present list information updated successfully.';
            })
            .catch(error => {
                document.getElementById('updateInfoResponse').innerText = 'Error updating present list information';
                alert('Error updating present list information: ' + error.message);
            });
        });

    </script>
</body>
</html>
